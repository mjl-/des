#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

typedef unsigned char uchar;
typedef unsigned long long uvlong;
#include "des.h"

#define nelem(p)	(sizeof (p)/sizeof (p[0]))

void
p64(uchar *p, uvlong v)
{
	int i;
	for(i = 0; i < 8; i++)
		*p++ = v>>(64-8-i*8);
}

uvlong tests[][3] = {
{0x0000000000000000ULL, 0x0000000000000000ULL, 0x8CA64DE9C1B123A7ULL},
{0xFFFFFFFFFFFFFFFFULL, 0xFFFFFFFFFFFFFFFFULL, 0x7359B2163E4EDC58ULL},
{0x3000000000000000ULL, 0x1000000000000001ULL, 0x958E6E627A05557BULL},
{0x1111111111111111ULL, 0x1111111111111111ULL, 0xF40379AB9E0EC533ULL},
{0x0123456789ABCDEFULL, 0x1111111111111111ULL, 0x17668DFC7292532DULL},
{0x1111111111111111ULL, 0x0123456789ABCDEFULL, 0x8A5AE1F81AB8F2DDULL},
{0x0000000000000000ULL, 0x0000000000000000ULL, 0x8CA64DE9C1B123A7ULL},
{0xFEDCBA9876543210ULL, 0x0123456789ABCDEFULL, 0xED39D950FA74BCC4ULL},
{0x7CA110454A1A6E57ULL, 0x01A1D6D039776742ULL, 0x690F5B0D9A26939BULL},
{0x0131D9619DC1376EULL, 0x5CD54CA83DEF57DAULL, 0x7A389D10354BD271ULL},
{0x07A1133E4A0B2686ULL, 0x0248D43806F67172ULL, 0x868EBB51CAB4599AULL},
{0x3849674C2602319EULL, 0x51454B582DDF440AULL, 0x7178876E01F19B2AULL},
{0x04B915BA43FEB5B6ULL, 0x42FD443059577FA2ULL, 0xAF37FB421F8C4095ULL},
{0x0113B970FD34F2CEULL, 0x059B5E0851CF143AULL, 0x86A560F10EC6D85BULL},
{0x0170F175468FB5E6ULL, 0x0756D8E0774761D2ULL, 0x0CD3DA020021DC09ULL},
{0x43297FAD38E373FEULL, 0x762514B829BF486AULL, 0xEA676B2CB7DB2B7AULL},
{0x07A7137045DA2A16ULL, 0x3BDD119049372802ULL, 0xDFD64A815CAF1A0FULL},
{0x04689104C2FD3B2FULL, 0x26955F6835AF609AULL, 0x5C513C9C4886C088ULL},
{0x37D06BB516CB7546ULL, 0x164D5E404F275232ULL, 0x0A2AEEAE3FF4AB77ULL},
{0x1F08260D1AC2465EULL, 0x6B056E18759F5CCAULL, 0xEF1BF03E5DFA575AULL},
{0x584023641ABA6176ULL, 0x004BD6EF09176062ULL, 0x88BF0DB6D70DEE56ULL},
{0x025816164629B007ULL, 0x480D39006EE762F2ULL, 0xA1F9915541020B56ULL},
{0x49793EBC79B3258FULL, 0x437540C8698F3CFAULL, 0x6FBF1CAFCFFD0556ULL},
{0x4FB05E1515AB73A7ULL, 0x072D43A077075292ULL, 0x2F22E49BAB7CA1ACULL},
{0x49E95D6D4CA229BFULL, 0x02FE55778117F12AULL, 0x5A6B612CC26CCE4AULL},
{0x018310DC409B26D6ULL, 0x1D9D5C5018F728C2ULL, 0x5F4C038ED12B2E41ULL},
{0x1C587F1C13924FEFULL, 0x305532286D6F295AULL, 0x63FAC0D034D9F793ULL},
{0x0101010101010101ULL, 0x0123456789ABCDEFULL, 0x617B3A0CE8F07100ULL},
{0x1F1F1F1F0E0E0E0EULL, 0x0123456789ABCDEFULL, 0xDB958605F8C8C606ULL},
{0xE0FEE0FEF1FEF1FEULL, 0x0123456789ABCDEFULL, 0xEDBFD1C66C29CCC7ULL},
{0x0000000000000000ULL, 0xFFFFFFFFFFFFFFFFULL, 0x355550B2150E2451ULL},
{0xFFFFFFFFFFFFFFFFULL, 0x0000000000000000ULL, 0xCAAAAF4DEAF1DBAEULL},
{0x0123456789ABCDEFULL, 0x0000000000000000ULL, 0xD5D44FF720683D0DULL},
{0xFEDCBA9876543210ULL, 0xFFFFFFFFFFFFFFFFULL, 0x2A2BB008DF97C2F2ULL},
};

int
main(int argc, char *argv[])
{
	Desks ks;
	int i;
	uchar k[8], p[8], c[8];

	for(i = 0; i < nelem(tests); i++) {
		p64(k, tests[i][0]);
		p64(p, tests[i][1]);
		p64(c, tests[i][2]);
		deskey64(&ks, k);
		desenc(&ks, p);
		if(memcmp(p, c, 8) != 0) {
			fprintf(stderr, "bad des, test %d, encrypt failed (%llx %llx %llx)\n", i, tests[i][0], tests[i][1], tests[i][2]);
			exit(1);
		}
		p64(p, tests[i][1]);
		desdec(&ks, c);
		if(memcmp(p, c, 8) != 0) {
			fprintf(stderr, "bad des, test %d, decrypt failed (%llx %llx %llx)\n", i, tests[i][0], tests[i][1], tests[i][2]);
			exit(1);
		}
		printf("test %d passed\n", i);
	}
	printf("all tests passed\n");
	return 0;
}
